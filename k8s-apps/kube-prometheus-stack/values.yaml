kube-prometheus-stack:
  prometheus:
    # ref: https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#prometheusspec
    prometheusSpec:
      # ref: https://github.com/prometheus-operator/prometheus-operator/blob/release-0.44/pkg/prometheus/promcfg.go#L180-L183
      scrapeInterval: 15s

      retention: 3d

      # Watch all PrometheusRules in the cluster.
      ruleNamespaceSelector:
        matchLabels: {}
      ruleSelector:
        matchLabels: {}

      # Watch all ServiceMonitors in the cluster.
      serviceMonitorNamespaceSelector:
        matchLabels: {}
      serviceMonitorSelector:
        matchLabels: {}

      # Watch all PodMonitors in the cluster.
      podMonitorSelector:
        matchLabels: {}
      podMonitorNamespaceSelector:
        matchLabels: {}

      resources:
        requests:
          cpu: 1000m
          memory: 1Gi
        limits:
          cpu: 2000m
          memory: 2Gi

      # ref: https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/user-guides/storage.md
      storageSpec:
        volumeClaimTemplate:
          metadata:
            annotations:
              helm.sh/resource-policy: keep
              argocd.argoproj.io/sync-options: Delete=false
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi

      thanos: {}
        # objectStorageConfig:
        #   key: objstore.yml
        #   name: thanos-objstore-secret

    ingress:
      enabled: true
      ingressClassName: traefik

      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
      hosts:
        - prometheus.terence.cloud
      tls:
        - secretName: prometheus-general-tls
          hosts:
            - prometheus.terence.cloud

    thanosService:
      enabled: false

    thanosServiceMonitor:
      enabled: false

  # ==============================================================================
  # Grafana
  # Default values: https://github.com/grafana/helm-charts/blob/main/charts/grafana/values.yaml
  # ==============================================================================

  grafana:
    defaultDashboardsTimezone: Europe/Paris

    # Required as long as Grafana's persistent volume is ReadWriteOnce.
    # During a rolling update, the new Grafana pod would not be able to start
    # while the old pod still holds the volume.
    deploymentStrategy:
      type: Recreate

    serviceMonitor:
      scrapeTimeout: 5s

    envFromSecret: pocket-id-credentials

    labels:
      sablier.enable: "true"
      sablier.group: "grafana"

    ingress:
      enabled: true
      ingressClassName: traefik

      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        cert-manager.io/issue-temporary-certificate: "true"
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        traefik.ingress.kubernetes.io/router.middlewares: monitoring-sablier@kubernetescrd,traefik-modsecurity@kubernetescrd
      hosts:
        - grafana.terence.cloud
      tls:
        - secretName: grafana-general-tls
          hosts:
            - grafana.terence.cloud

    # The oAuth2 proxy handles authentication, not Grafana.
    grafana.ini:
      server:
        root_url: https://grafana.terence.cloud
      auth:
        disable_login_form: true
        signout_redirect_url: https://auth.terence.cloud/api/oidc/end-session
        oauth_allow_insecure_email_lookup: true
      auth.basic:
        enabled: false
      auth.generic_oauth:
        enabled: true
        name: Pocket ID
        auto_login: true
        allow_sign_up: true
        scopes: openid email profile
        auth_url: https://auth.terence.cloud/authorize
        token_url: https://auth.terence.cloud/api/oidc/token
        api_url: https://auth.terence.cloud/api/oidc/userinfo
        client_id: 1eded5c9-3543-4344-bd35-67a741fc0d8a
      users:
        allow_sign_up: false
        auto_assign_org: true
        auto_assign_org_role: Admin

    resources:
      requests:
        cpu: 50m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 512Mi

    livenessProbe:
      initialDelaySeconds: 30

    # Organise dashboards by provider, with the provider's name as the key.
    dashboards:
      default: # The "default" provider is defined below.
        cloudnativepg:
          gnetId: 20417
          datasource: Prometheus
        longhorn:
          gnetId: 16888
          datasource: Prometheus
      extra: {}
        # pihole-overview:
        #   gnetId: 10176
        #   datasource: Prometheus
        # argocd-overview:
        #   gnetId: 14584
        #   datasource: Prometheus
        # cert-manager-overview:
        #   gnetId: 11001
        #   datasource: Prometheus
        # external-dns-overview:
        #   gnetId: 15038
        #   datasource: Prometheus
        # blackbox-exporter-overview:
        #   gnetId: 5345
        #   datasource: Prometheus
        # thanos-overview:
        #   gnetId: 12937
        #   datasource: Thanos

    # Configure dashboard providers.
    # ref: http://docs.grafana.org/administration/provisioning/#dashboards
    # `path` must be /var/lib/grafana/dashboards/<provider_name>
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: default
            orgId: 1
            folder: ""
            type: file
            disableDeletion: false
            editable: true
            allowUiUpdates: true
            options:
              path: /var/lib/grafana/dashboards/default
          - name: "extra"
            orgId: 1
            folder: "Extra"
            type: file
            disableDeletion: true
            editable: true
            allowUiUpdates: true
            options:
              path: /var/lib/grafana/dashboards/extra

    persistence:
      enabled: true
      size: 10Gi
      accessModes:
        - ReadWriteOnce
      finalizers:
        - kubernetes.io/pvc-protection
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false

    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://kube-prometheus-stack-prometheus:9090
            access: proxy
          - name: Loki
            type: loki
            url: http://loki-gateway.loki
            access: proxy

    plugins:
      - grafana-piechart-panel
  # ==============================================================================
  # Alertmanager
  # ref: https://prometheus.io/docs/alerting/alertmanager/
  # ==============================================================================

  alertmanager:
    enabled: true
    alertmanagerSpec:
      # useExistingSecret: true
      secrets:
        - telegram-bot-token
      storage:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 1Gi

    config:
      receivers:
        - name: empty
        - name: telegram
          telegram_configs:
            - send_resolved: true
              bot_token_file: /etc/alertmanager/secrets/telegram-bot-token/token
              chat_id: -1002235030838
              message: |
                {{- define "telegram.alert_list" -}}
                  {{- $maxLength := 3900 -}}
                  {{- $message := "" -}}
                  {{- $message_is_truncated := false -}}
                  {{- $message_no_labels := "" -}}
                  {{- $message_no_labels_is_truncated := false -}}

                  {{- range .Alerts -}}
                    {{- $escape_regex := "([-_*\\[\\]()~`>#+=|{}.!])" -}}

                    {{- /* Build alert text */ -}}
                    {{- $alertText := ""}}
                    {{- if eq .Status "firing" }}
                      {{- $alertText = "üî• "}}
                    {{- end -}}
                    {{- if eq .Status "resolved" }}
                      {{- $alertText = "‚úÖ "}}
                    {{- end -}}

                    {{- $title := .Labels.alertname | reReplaceAll  $escape_regex "\\$1" -}}
                    {{- if .Annotations.summary}}
                      {{- $title = printf "%s \\- %s" $title (.Annotations.summary | reReplaceAll  $escape_regex "\\$1")  -}}
                    {{- end }}

                    {{- $alertText = printf "%s***\\<%s\\> %s***\n" $alertText ( or .Labels.severity "no severity") $title -}}
                    {{- if .Annotations.description}}
                      {{- $alertText = printf "%s_%s_\n" $alertText ( .Annotations.description | reReplaceAll $escape_regex "\\$1" ) -}}
                    {{- end }}

                    {{- if .GeneratorURL -}}
                      {{- $alertText = printf "%s[Source](%s)" $alertText (.GeneratorURL) -}}
                    {{- end }}

                    {{- if .Annotations.runbook_url -}}
                      {{- $alertText = printf "%s [Runbook](%s)" $alertText (.Annotations.runbook_url) -}}
                    {{- end -}}

                    {{- /* Store alert text without labels in case all alerts would not fit message length limit  */ -}}
                    {{- $message_tmp := "" -}}
                    {{- if $message_no_labels  -}}
                      {{- $message_tmp = printf "%s\n\n%s" $message_no_labels $alertText -}}
                    {{- else -}}
                      {{- $message_tmp = printf "%s" $alertText -}}
                    {{- end -}}

                    {{- if $message_tmp | len | gt $maxLength  -}}
                      {{- $message_no_labels = $message_tmp -}}
                    {{- else -}}
                      {{- $message_no_labels_is_truncated = true -}}
                    {{- end -}}

                    {{- /* Add labels to alert text */ -}}
                    {{- range .Labels.SortedPairs -}}
                      {{- if (eq .Name "alertname" "description" "summary" "runbook_url" "severity" "prometheus" ) | not -}}
                      {{- $alertText = printf "%s\nüè∑ %s: `%s`" $alertText (.Name | reReplaceAll $escape_regex "\\$1" ) .Value -}}
                      {{- end -}}
                    {{- end }}

                    {{- $message_tmp := "" -}}
                    {{- if $message  -}}
                      {{- $message_tmp = printf "%s\n\n%s" $message $alertText -}}
                    {{- else -}}
                      {{- $message_tmp = printf "%s" $alertText -}}
                    {{- end -}}

                    {{- if $message_tmp | len | gt $maxLength  -}}
                      {{- $message = $message_tmp -}}
                    {{- else -}}
                      {{- $message_is_truncated = true -}}
                    {{- end -}}

                  {{- end -}}

                  {{- $message =  printf "%s\n" $message -}}
                  {{- if $message_is_truncated -}}
                    {{- $message =  printf "%s\nMessage is truncated to fit telegram API limit" $message -}}
                  {{- end -}}

                  {{- $message_no_labels =  printf "%s\n" $message_no_labels -}}
                  {{- if $message_no_labels_is_truncated -}}
                    {{- $message_no_labels =  printf "%s\nMessage is truncated to fit telegram API limit" $message_no_labels -}}
                  {{- end -}}

                  {{- if $message_is_truncated -}}
                    {{- $message_no_labels -}}
                  {{- else -}}
                    {{- $message -}}
                  {{- end -}}
                {{- end -}}

                {{- define "telegram.message" -}}
                üî•  firing: {{ len .Alerts.Firing }} ‚úÖ resolved: {{ len .Alerts.Resolved }}

                {{ template "telegram.alert_list" . }}
                [See On AlertManager]({{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }})
                \#alerts
                {{- end -}}
      route:
        group_by: ["alertname"]
        group_wait: 0s
        receiver: telegram
        routes:
          - matchers:
              - alertname=~"CNPGClusterHA.*|KubeCPUOvercommit|KubeMemoryOvercommit|Watchdog|InfoInhibitor"
            receiver: empty

    ingress:
      enabled: true
      ingressClassName: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
      hosts:
        - alertmanager.terence.cloud
      paths:
        - /
      pathType: ImplementationSpecific
      tls:
        - secretName: alertmanager-tls
          hosts:
            - alertmanager.terence.cloud

  kubeControllerManager:
    enabled: false

  kubeEtcd:
    enabled: false

  kubeScheduler:
    enabled: false

  kubeProxy:
    enabled: false
