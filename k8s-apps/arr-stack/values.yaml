# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/library/common/values.schema.json
app-template:
  defaultPodOptions:
    automountServiceAccountToken: false
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: "OnRootMismatch"

  controllers:
    jellyfin:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
        securityContext:
          runAsUser: 0
          runAsGroup: 0
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - "{{ .Release.Name }}"
                topologyKey: kubernetes.io/hostname
      containers:
        jellyfin:
          image:
            repository: lscr.io/linuxserver/jellyfin
            tag: 10.11.6ubu2404-ls20@sha256:45814a5515fdb81cd41f5db946cfd53a3c5e91f0665b40b55bae30cab4b3cd2e
          env:
            TZ: Europe/Paris
            PUID: 0
            PGID: 0
          ports:
            - name: http
              containerPort: 8096
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /health
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/sh
                    - -c
                    - grep -q '<IsStartupWizardCompleted>true</IsStartupWizardCompleted>' /config/system.xml && exit 0 || exit 1
          securityContext:
            privileged: true

    jellyseerr:
      type: deployment
      strategy: Recreate
      labels:
        sablier.enable: "true"
        sablier.group: "js"
      annotations:
        reloader.stakater.com/auto: "true"
      containers:
        jellyseerr:
          image:
            repository: fallenbagel/jellyseerr
            tag: 2.7.3@sha256:4538137bc5af902dece165f2bf73776d9cf4eafb6dd714670724af8f3eb77764
          env:
            TZ: Europe/Paris
          ports:
            - name: http
              containerPort: 5055
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /api/v1/status
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /api/v1/status
          securityContext:
            privileged: true

    jellystat:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        securityContext:
          runAsUser: 0
          runAsGroup: 0
      containers:
        jellystat:
          image:
            repository: cyfershepard/jellystat
            tag: 1.1.8@sha256:c8c451704ba7985340142cd047e2364cabaf41b613669b6c5340688ed217f82a
          ports:
            - name: http
              containerPort: 3000
          env:
            TZ: Europe/Paris
            MINIMUM_SECONDS_TO_INCLUDE_PLAYBACK: "120"
            POSTGRES_IP:
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-cnpg-cluster-jellystat-app"
                  key: host
            POSTGRES_USER:
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-cnpg-cluster-jellystat-app"
                  key: user
            POSTGRES_PORT:
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-cnpg-cluster-jellystat-app"
                  key: port
            POSTGRES_PASSWORD:
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-cnpg-cluster-jellystat-app"
                  key: password
            POSTGRES_DB:
              valueFrom:
                secretKeyRef:
                  name: "{{ .Release.Name }}-cnpg-cluster-jellystat-app"
                  key: dbname
            JWT_SECRET:
              valueFrom:
                secretKeyRef:
                  name: "jellystat-jwt-secret"
                  key: password
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /auth/isconfigured
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /auth/isconfigured
    sonarr:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - "{{ .Release.Name }}"
                topologyKey: kubernetes.io/hostname
      containers:
        sonarr:
          image:
            repository: lscr.io/linuxserver/sonarr
            tag: 4.0.16.2944-ls303@sha256:37be832b78548e3f55f69c45b50e3b14d18df1b6def2a4994258217e67efb1a1
          env:
            TZ: Europe/Paris
            PUID: 1000
            PGID: 1000
          ports:
            - name: http
              containerPort: 8989
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /ping
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /ping

    radarr:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - "{{ .Release.Name }}"
                topologyKey: kubernetes.io/hostname
      containers:
        radarr:
          image:
            repository: lscr.io/linuxserver/radarr
            tag: 6.0.4.10291-ls292@sha256:f08dda38e7d12e5a722d9a5cb6e54acaf63c8598fefeefec88effe0c0d0038dd
          env:
            TZ: Europe/Paris
            PUID: 1000
            PGID: 1000
          ports:
            - name: http
              containerPort: 7878
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /ping
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /ping

    lidarr:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
        securityContext:
          runAsUser: 0
          runAsGroup: 0
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - "{{ .Release.Name }}"
                topologyKey: kubernetes.io/hostname
      containers:
        lidarr:
          image:
            repository: lscr.io/linuxserver/lidarr
            tag: 3.1.0.4875-ls20@sha256:37a3df74f4c2a6f10eead66f4d8034362ebf2866f935026b4a71dd888b9e7f08
          env:
            TZ: Europe/Paris
            PUID: 1000
            PGID: 1000
          ports:
            - name: http
              containerPort: 8686
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /ping
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /ping

    prowlarr:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      containers:
        prowlarr:
          image:
            repository: lscr.io/linuxserver/prowlarr
            tag: 2.3.0.5236-ls137@sha256:e74a1e093dcc223d671d4b7061e2b4946f1989a4d3059654ff4e623b731c9134
          env:
            TZ: Europe/Paris
            PUID: 1000
            PGID: 1000
          ports:
            - name: http
              containerPort: 9696
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /ping
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /ping

    bazarr:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - "{{ .Release.Name }}"
                topologyKey: kubernetes.io/hostname
      containers:
        bazarr:
          image:
            repository: lscr.io/linuxserver/bazarr
            tag: v1.5.5-ls337@sha256:18ff732dffcebd559d15a91845fc3360d49652ea01dccfbfd98b8248ceb86e38
          env:
            TZ: Europe/Paris
            PUID: 1000
            PGID: 1000
          ports:
            - name: http
              containerPort: 6767
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /system/ping
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /system/ping

    configarr:
      type: cronjob
      annotations:
        reloader.stakater.com/auto: "true"
      cronjob:
        schedule: "0 0 * * *"
        successfulJobsHistory: 1
        failedJobsHistory: 1
      containers:
        configarr:
          image:
            repository: configarr/configarr
            tag: 1.20.0@sha256:40180ae49ed3caab864f65682da14b172281edb19924e60a5fd357b2234cb987
          env:
            TZ: Europe/Paris

    rangemusique:
      type: cronjob
      cronjob:
        schedule: "4/5 * * * *"
        successfulJobsHistory: 1
        failedJobsHistory: 1
      containers:
        rangemusique:
          image:
            repository: ghcr.io/cterence/rangemusique
            tag: latest@sha256:2803ba5a6671e8ea20d13b035d5786a04ec994becae324a3b3cb6e3c45e2195a
          env:
            TZ: Europe/Paris
            INPUT_DIR: /in
            OUTPUT_DIR: /out
            JELLYFIN_URL: http://arr-stack-jellyfin:8096
            LIDARR_URL: http://arr-stack-lidarr:8686
          envFrom:
            - secretRef:
                name: rangemusique-api-keys
          command: /bin/bash
          args: ["/run-rangemusique.sh"]

    flaresolverr:
      type: deployment
      strategy: RollingUpdate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        securityContext:
          runAsUser: 0
          runAsGroup: 0
      containers:
        flaresolverr:
          image:
            repository: ghcr.io/flaresolverr/flaresolverr
            tag: v3.4.6@sha256:7962759d99d7e125e108e0f5e7f3cdbcd36161776d058d1d9b7153b92ef1af9e
          env:
            TZ: Europe/Paris
          ports:
            - name: http
              containerPort: 8191
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /health
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /health

    flareproxy:
      type: deployment
      strategy: RollingUpdate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        securityContext:
          runAsUser: 0
          runAsGroup: 0
      containers:
        flareproxy:
          image:
            repository: mickey3721/flareproxy
            tag: latest@sha256:5d6b4ea0c6b9024a6de9933e18fe068f2a92504e5a41d3212036cf519885bbc3
          env:
            TZ: Europe/Paris
            FLARESOLVERR_URL: http://arr-stack-flaresolverr:8191/v1
          ports:
            - name: http
              containerPort: 8080
          # probes:
          #   liveness:
          #     enabled: true
          #     custom: true
          #     spec:
          #       httpGet:
          #         port: http
          #         path: /
          #   readiness:
          #     enabled: true
          #     custom: true
          #     spec:
          #       httpGet:
          #         port: http
          #         path: /

    qbittorrent:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - "{{ .Release.Name }}"
                topologyKey: kubernetes.io/hostname
      initContainers:
        gluetun:
          image:
            repository: ghcr.io/qdm12/gluetun
            tag: v3.41.1@sha256:1a5bf4b4820a879cdf8d93d7ef0d2d963af56670c9ebff8981860b6804ebc8ab
          env:
            TZ: Europe/Paris
            VPN_SERVICE_PROVIDER: airvpn
            VPN_TYPE: wireguard
            VPN_INTERFACE: wg0
            SERVER_REGIONS: Europe
            WIREGUARD_ADDRESSES: 10.145.193.219/32,fd7d:76ee:e68f:a993:7c10:4d59:a5d7:9537/128
            FIREWALL_VPN_INPUT_PORTS: "6887"
            DNS_ADDRESS: 1.1.1.1
          restartPolicy: Always
          envFrom:
            - secretRef:
                name: gluetun-wg-keys
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
            runAsUser: 0
            runAsGroup: 0
            privileged: true
      containers:
        qbittorrent:
          image:
            repository: lscr.io/linuxserver/qbittorrent
            tag: 5.1.4-r0-ls429@sha256:a2eedc99b4876916943bd33e7c415efc448f6b514aa39b4f98c1e6472a717301
          env:
            TZ: Europe/Paris
            PUID: 1000
            PGID: 1000
            TORRENTING_PORT: 6887
          ports:
            - name: http
              containerPort: 8080
          probes:
            liveness:
              enabled: true
              type: HTTP
            readiness:
              enabled: true
              type: HTTP

    filebrowser-quantum:
      type: deployment
      strategy: Recreate
      labels:
        sablier.enable: "true"
        sablier.group: "fbq"
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - "{{ .Release.Name }}"
                topologyKey: kubernetes.io/hostname
      containers:
        filebrowser-quantum:
          image:
            repository: ghcr.io/gtsteffaniak/filebrowser
            tag: 1.1.2-stable@sha256:24b80967bea15d5595c28065146ff7a931f0538c110f34748c037979ef2d634e
          env:
            TZ: Europe/Paris
            PUID: 1000
            PGID: 1000
            PORT: 8080
          ports:
            - name: http
              containerPort: 8080
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /health
            readiness:
              enabled: true
              spec:
                httpGet:
                  port: http
                  path: /health

    slskd:
      type: deployment
      strategy: Recreate
      annotations:
        reloader.stakater.com/auto: "true"
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - "{{ .Release.Name }}"
                topologyKey: kubernetes.io/hostname
      containers:
        slskd:
          image:
            repository: slskd/slskd
            tag: 0.24.3@sha256:bcf9820dab68e21d2bba8ebb1ffd583d71fcba542a50a1e998119f69b7b498fe
          env:
            TZ: Europe/Paris
            PUID: "1000"
            PGID: "1000"
            SLSKD_CONFIG: /config/slskd.yml
          ports:
            - name: http
              containerPort: 5030
            - name: slskd
              containerPort: 39332
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /health
            readiness:
              enabled: true
              spec:
                httpGet:
                  port: http
                  path: /health

        gluetun:
          dependsOn: slskd
          image:
            repository: ghcr.io/qdm12/gluetun
            tag: v3.41.1@sha256:1a5bf4b4820a879cdf8d93d7ef0d2d963af56670c9ebff8981860b6804ebc8ab
          env:
            TZ: Europe/Paris
            VPN_SERVICE_PROVIDER: airvpn
            VPN_TYPE: wireguard
            VPN_INTERFACE: wg2
            SERVER_REGIONS: Europe
            WIREGUARD_ADDRESSES: 10.165.132.142/32,fd7d:76ee:e68f:a993:98e4:695c:3789:4b9d/128
            FIREWALL_VPN_INPUT_PORTS: "39332"
          envFrom:
            - secretRef:
                name: gluetun-slskd-wg-keys
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
            runAsUser: 0
            runAsGroup: 0
            privileged: true

    soularr:
      type: cronjob
      pod:
        annotations:
          backup.velero.io/backup-volumes-excludes: data
      cronjob:
        schedule: "*/5 * * * *"
        successfulJobsHistory: 1
        failedJobsHistory: 1
        concurrencyPolicy: Forbid
      annotations:
        reloader.stakater.com/auto: "true"
      containers:
        soularr:
          image:
            repository: mrusse08/soularr
            tag: latest@sha256:ffe38750acee3200581ddd976aac1d69dc1001464b92c25bd7334db008d748d9
          env:
            TZ: Europe/Paris
          command: /bin/bash
          args: ["/run-soularr.sh"]

  service:
    jellyfin:
      controller: jellyfin
      type: ClusterIP
      ports:
        http:
          port: 8096
    jellyseerr:
      controller: jellyseerr
      type: ClusterIP
      ports:
        http:
          port: 5055
    jellystat:
      controller: jellystat
      type: ClusterIP
      ports:
        http:
          port: 3000
    sonarr:
      controller: sonarr
      type: ClusterIP
      ports:
        http:
          port: 8989
    radarr:
      controller: radarr
      type: ClusterIP
      ports:
        http:
          port: 7878
    lidarr:
      controller: lidarr
      type: ClusterIP
      ports:
        http:
          port: 8686
    prowlarr:
      controller: prowlarr
      type: ClusterIP
      ports:
        http:
          port: 9696
    bazarr:
      controller: bazarr
      type: ClusterIP
      ports:
        http:
          port: 6767
    flaresolverr:
      controller: flaresolverr
      type: ClusterIP
      ports:
        http:
          port: 8191
    flareproxy:
      controller: flareproxy
      type: ClusterIP
      ports:
        http:
          port: 8080
    qbittorrent:
      controller: qbittorrent
      type: ClusterIP
      ports:
        http:
          port: 8080
    filebrowser-quantum:
      controller: filebrowser-quantum
      type: ClusterIP
      ports:
        http:
          port: 8080
    slskd:
      controller: slskd
      type: ClusterIP
      ports:
        http:
          port: 5030

  ingress:
    jellyfin:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host jf.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: jellyfin
                port: http
      tls:
        - secretName: jellyfin-tls
          hosts:
            - *host

    jellyfin-media:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        traefik.ingress.kubernetes.io/router.priority: "100"
      className: "traefik"
      hosts:
        - host: &host jf.terence.cloud
          paths:
            - path: /videos
              pathType: Prefix
              service:
                identifier: jellyfin
                port: http
            - path: /audio
              pathType: Prefix
              service:
                identifier: jellyfin
                port: http
            - path: /socket.io
              pathType: Prefix
              service:
                identifier: jellyfin
                port: http
      tls:
        - secretName: jellyfin-tls
          hosts:
            - *host

    jellyseerr:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        traefik.ingress.kubernetes.io/router.middlewares: "{{ .Release.Namespace }}-sablier-js@kubernetescrd,traefik-modsecurity@kubernetescrd"
      className: "traefik"
      hosts:
        - host: &host js.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: jellyseerr
                port: http
      tls:
        - secretName: jellyseerr-tls
          hosts:
            - *host

    jellystat:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host jstat.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: jellystat
                port: http
      tls:
        - secretName: jellystat-tls
          hosts:
            - *host

    sonarr:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host son.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: sonarr
                port: http
      tls:
        - secretName: sonarr-tls
          hosts:
            - *host

    radarr:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host rad.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: radarr
                port: http
      tls:
        - secretName: radarr-tls
          hosts:
            - *host

    lidarr:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host lid.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: lidarr
                port: http
      tls:
        - secretName: lidarr-tls
          hosts:
            - *host

    prowlarr:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host prow.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: prowlarr
                port: http
      tls:
        - secretName: prowlarr-tls
          hosts:
            - *host

    bazarr:
      annotations:
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host baz.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: bazarr
                port: http
      tls:
        - secretName: bazarr-tls
          hosts:
            - *host

    qbittorrent:
      annotations:
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host qb.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: qbittorrent
                port: http
      tls:
        - secretName: qbittorrent-tls
          hosts:
            - *host

    filebrowser-quantum:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
        traefik.ingress.kubernetes.io/router.middlewares: "{{ .Release.Namespace }}-sablier-fbq@kubernetescrd,traefik-modsecurity@kubernetescrd"
      className: "traefik"
      hosts:
        - host: &host fbq.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: filebrowser-quantum
                port: http
      tls:
        - secretName: filebrowser-quantum-tls
          hosts:
            - *host

    slskd:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        external-dns.alpha.kubernetes.io/target: home.terence.cloud
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
        traefik.ingress.kubernetes.io/router.middlewares: traefik-modsecurity@kubernetescrd
        traefik.ingress.kubernetes.io/router.tls.options: cert-manager-client-auth@kubernetescrd
      className: "traefik"
      hosts:
        - host: &host slskd.terence.cloud
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: slskd
                port: http
      tls:
        - secretName: slskd-tls
          hosts:
            - *host

  persistence:
    data:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 1200Gi
      labels:
        velero.io/exclude-from-backup: "true"
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      advancedMounts:
        jellyfin:
          jellyfin:
            - path: /data/media
              subPath: media
        sonarr:
          sonarr:
            - path: /data
        radarr:
          radarr:
            - path: /data
        lidarr:
          lidarr:
            - path: /data
        bazarr:
          bazarr:
            - path: /data
        qbittorrent:
          qbittorrent:
            - path: /data/download
              subPath: download
        filebrowser-quantum:
          filebrowser-quantum:
            - path: /data
        slskd:
          slskd:
            - path: /download
              subPath: download/slskd
        soularr:
          soularr:
            - path: /downloads
              subPath: download/slskd/complete
        rangemusique:
          rangemusique:
            - path: /in
              subPath: download/slskd/complete

    music:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 100Gi
      advancedMounts:
        lidarr:
          lidarr:
            - path: /data/media/music
        filebrowser-quantum:
          filebrowser-quantum:
            - path: /music
        slskd:
          slskd:
            - path: /music
        jellyfin:
          jellyfin:
            - path: /data/media/music
        soularr:
          soularr:
            - path: /data
        rangemusique:
          rangemusique:
            - path: /out

    jellyfin-config:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 30Gi
      advancedMounts:
        jellyfin:
          jellyfin:
            - path: /config

    jellyfin-hwa:
      enabled: true
      type: hostPath
      hostPath: /dev/dri/renderD128
      hostPathType: "CharDevice"
      advancedMounts:
        jellyfin:
          jellyfin:
            - path: /dev/dri/renderD128

    jellyseerr-config:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 1Gi
      advancedMounts:
        jellyseerr:
          jellyseerr:
            - path: /app/config

    jellystat-backup-data:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 1Gi
      advancedMounts:
        jellystat:
          jellystat:
            - path: /app/backend/backup-data

    sonarr-config:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 1Gi
      advancedMounts:
        sonarr:
          sonarr:
            - path: /config

    radarr-config:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 1Gi
      advancedMounts:
        radarr:
          radarr:
            - path: /config

    lidarr-config:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 2Gi
      advancedMounts:
        lidarr:
          lidarr:
            - path: /config

    qbittorrent-config:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 1Gi
      advancedMounts:
        qbittorrent:
          qbittorrent:
            - path: /config

    gluetun-device:
      enabled: true
      type: hostPath
      hostPath: /dev/net/tun
      hostPathType: "CharDevice"
      advancedMounts:
        qbittorrent:
          gluetun:
            - path: /dev/net/tun

    prowlarr-config:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 3Gi
      advancedMounts:
        prowlarr:
          prowlarr:
            - path: /config

    bazarr-config:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 100Mi
      advancedMounts:
        bazarr:
          bazarr:
            - path: /config

    configarr-cache:
      enabled: true
      type: emptyDir
      advancedMounts:
        configarr:
          configarr:
            - path: /app/repos
              subPath: configarr-repos

    configarr-config:
      type: configMap
      identifier: configarr-config
      advancedMounts:
        configarr:
          configarr:
            - path: /app/config/config.yml
              subPath: config.yml

    configarr-secrets:
      enabled: true
      type: secret
      name: configarr-secrets
      items:
        - key: secrets.yml
          path: secrets.yml
      advancedMounts:
        configarr:
          configarr:
            - path: /app/config/secrets.yml
              subPath: secrets.yml

    filebrowser-quantum-db:
      enabled: true
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 100Mi
      advancedMounts:
        filebrowser-quantum:
          filebrowser-quantum:
            - path: /home/filebrowser/database

    filebrowser-quantum-config:
      type: configMap
      identifier: filebrowser-quantum-config
      advancedMounts:
        filebrowser-quantum:
          filebrowser-quantum:
            - path: /home/filebrowser/config.yaml
              subPath: config.yaml

    slskd-config:
      type: secret
      name: slskd-config
      advancedMounts:
        slskd:
          slskd:
            - path: /config
              readOnly: true

    slskd-data:
      type: persistentVolumeClaim
      annotations:
        helm.sh/resource-policy: keep
        argocd.argoproj.io/sync-options: Delete=false
      accessMode: ReadWriteOnce
      size: 500Mi
      advancedMounts:
        slskd:
          slskd:
            - path: /app

    gluetun-slskd-device:
      enabled: true
      type: hostPath
      hostPath: /dev/net/tun
      hostPathType: "CharDevice"
      advancedMounts:
        slskd:
          gluetun:
            - path: /dev/net/tun

    soularr-config:
      type: secret
      name: soularr-config
      advancedMounts:
        soularr:
          soularr:
            - path: /data/config.ini
              subPath: config.ini

    soularr-script:
      type: configMap
      identifier: soularr-script
      defaultMode: 0664
      advancedMounts:
        soularr:
          soularr:
            - path: /run-soularr.sh
              subPath: run-soularr.sh

    rangemusique-script:
      type: configMap
      identifier: rangemusique-script
      defaultMode: 0664
      advancedMounts:
        rangemusique:
          rangemusique:
            - path: /run-rangemusique.sh
              subPath: run-rangemusique.sh

  configMaps:
    configarr-config:
      data:
        config.yml: |
          trashGuideUrl: https://github.com/TRaSH-Guides/Guides
          recyclarrConfigUrl: https://github.com/recyclarr/config-templates

          sonarr:
            series:
              base_url: http://arr-stack-sonarr:8989
              api_key: !secret SONARR_API_KEY

              quality_definition:
                type: series

              include:
                - template: sonarr-quality-definition-series
                - template: sonarr-v4-quality-profile-web-1080p
                - template: sonarr-v4-custom-formats-web-1080p
                - template: sonarr-v4-quality-profile-bluray-web-1080p-french-vostfr
                - template: sonarr-v4-custom-formats-bluray-web-1080p-french-vostfr

              custom_formats: []

          radarr:
            movies:
              base_url: http://arr-stack-radarr:7878
              api_key: !secret RADARR_API_KEY

              include:
                - template: radarr-quality-definition-movie
                - template: radarr-quality-profile-hd-bluray-web
                - template: radarr-custom-formats-hd-bluray-web
                - template: radarr-quality-profile-remux-web-1080p
                - template: radarr-custom-formats-remux-web-1080p
                - template: radarr-quality-profile-hd-bluray-web-french-vostfr
                - template: radarr-custom-formats-hd-bluray-web-french-vostfr
                - template: radarr-quality-profile-hd-remux-web-french-vostfr
                - template: radarr-custom-formats-hd-remux-web-french-vostfr

              custom_formats: []

    filebrowser-quantum-config:
      data:
        config.yaml: |
          server:
            port: 8080
            database: "database/database.db"
            sources:
              - path: /data
              - path: /music
          auth:
            methods:
              noauth: true
          userDefaults:
            permissions:
              api: true
              admin: true
              modify: true
              share: true
              realtime: true

    soularr-script:
      data:
        run-soularr.sh: |
          #!/bin/bash

          FILE=/data/.soularr.lock
          touch $FILE
          echo "created lockfile at $FILE"
          python -u /app/soularr.py
          echo "soularr done"
          rm $FILE
          echo "removed lockfile at $FILE"

    rangemusique-script:
      data:
        run-rangemusique.sh: |
          #!/bin/bash

          FILE=/out/.soularr.lock
          if [ -f $FILE ]; then
            echo "soularr lockfile detected, not running rangemusique"
          else
            echo "soularr lockfile not detected, running rangemusique"
            /app/main
          fi

cnpg-cluster-jellystat:
  type: postgresql
  mode: standalone
  version:
    postgresql: "18"
  cluster:
    instances: 1
    imageCatalogRef:
      kind: ClusterImageCatalog
      name: postgresql
    storage:
      size: 5Gi
    roles:
      - name: jellystat
        connectionLimit: -1
        ensure: present
        createdb: true
        inherit: true
        login: true
    resources: {}
    primaryUpdateMethod: switchover
    primaryUpdateStrategy: unsupervised
    logLevel: "info"
    monitoring:
      enabled: true
      podMonitor:
        enabled: true
    postgresql: {}
    initdb:
      database: jellystat
