# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/common-3.7.3/charts/library/common/values.schema.json
app-template:
  configMaps:
    config:
      data:
        TZ: Europe/Paris
        CACHE_TYPE: redis
        REDIS_URL: redis://localhost:6379/0
        BROWSER_URL: ws://localhost:3000?token=local
        LOG_LEVEL: info
        DELETE: "true"

  controllers:
    app:
      type: cronjob
      cronjob:
        schedule: "0 0 * * *"
        successfulJobsHistory: 1
        failedJobsHistory: 1
        concurrencyPolicy: Forbid
        timeZone: Europe/Paris
      strategy: RollingUpdate
      pod:
        securityContext:
          fsGroup: 1000
      annotations:
        reloader.stakater.com/auto: "true"
      containers:
        app:
          image:
            repository: ghcr.io/cterence/scrobble-deduplicator
            tag: latest@sha256:ecd22208e3c9fd58f87c67af23d0f0cb50a22d2d1ca24092549b80765b87f232
          command:
            - /bin/bash
            - -c
            - /app/main --from $(date -d "yesterday" +"%d-%m-%Y")
          envFrom:
            - configMapRef:
                identifier: config
            - secretRef:
                name: lastfm-credentials
      # Long lived sidecars with restartPolicy: Always
      initContainers:
        redis:
          image:
            repository: redis
            tag: latest@sha256:cc2dfb8f5151da2684b4a09bd04b567f92d07591d91980eb3eca21df07e12760
          env:
            TZ: Europe/Paris
          args:
            - --save
            - --appendonly
            - "no"
          restartPolicy: Always
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/bash
                    - -c
                    - redis-cli ping
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/bash
                    - -c
                    - redis-cli ping

        chromium:
          image:
            repository: ghcr.io/browserless/chromium
            tag: latest@sha256:7c6621789a8c48fdcd4c20319b17191b142b091d611bd6e170bb6192856fa3ca
          ports:
            - name: http
              containerPort: 3000
          env:
            TZ: Europe/Paris
            TOKEN: local
            DEBUG: -*
            TIMEOUT: 600000
          restartPolicy: Always
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /active?token=local
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /active?token=local

  persistence:
    redis:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 200Mi
      advancedMounts:
        app:
          redis:
            - path: /data
    data:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 200Mi
      advancedMounts:
        app:
          app:
            - path: /app/data
