# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/common-3.7.3/charts/library/common/values.schema.json
app-template:
  configMaps:
    config:
      data:
        TZ: Europe/Paris
        CACHE_TYPE: redis
        BROWSER_HEADFUL: "false"
        REDIS_URL: redis://localhost:6379/0
        BROWSER_URL: ws://localhost:3000?token=local
        LOG_LEVEL: info
        DELETE: "false"

  controllers:
    app:
      type: cronjob
      cronjob:
        schedule: "0 0 * * *"
        successfulJobsHistory: 1
        failedJobsHistory: 1
        concurrencyPolicy: Forbid
        timeZone: Europe/Paris
      strategy: RollingUpdate
      annotations:
        reloader.stakater.com/auto: "true"
      containers:
        app:
          image:
            repository: ghcr.io/cterence/scrobble-deduplicator
            tag: latest@sha256:f30f872cc4b422eac378df35c407ef4413cf28431ef53c7a47dd73a7e840cbdd
          env:
            TZ: Europe/Paris
          command:
            - /bin/bash
            - -c
            - /app/main --start-day $(date -d "yesterday" +"%d-%m-%Y") --end-day $(date +"%d-%m-%Y")
          envFrom:
            - configMapRef:
                identifier: config
            - secretRef:
                name: lastfm-credentials
        redis:
          image:
            repository: redis
            tag: latest
          env:
            TZ: Europe/Paris
          args:
            - --save
            - --appendonly
            - "no"
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/bash
                    - -c
                    - redis-cli ping
            readiness:
              enabled: true
              custom: true
              spec:
                exec:
                  command:
                    - /bin/bash
                    - -c
                    - redis-cli ping

        chromium:
          image:
            repository: ghcr.io/browserless/chromium
            tag: latest
          ports:
            - name: http
              containerPort: 3000
          env:
            TZ: Europe/Paris
            TOKEN: local
            DEBUG: -*
            TIMEOUT: 600000
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /active?token=local
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  port: http
                  path: /active?token=local

  persistence:
    redis:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 200Mi
      advancedMounts:
        app:
          redis:
            - path: /data
